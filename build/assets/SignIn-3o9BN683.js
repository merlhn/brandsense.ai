import{r as d,s as t,l as r,j as e,C as y,B as N,p as w,b as T,t as A,S as f}from"./index-DWT5pgcS.js";import{L as k,I as C}from"./label-wIHa-TbB.js";import{S as B}from"./separator-Co7Z8xSH.js";import{A as I}from"./arrow-left-9CzPUcqL.js";import{L as P}from"./loader-circle-CbJEtXa7.js";function U({onNavigate:i}){const[m,S]=d.useState(""),[h,D]=d.useState(""),[g,n]=d.useState(""),[l,c]=d.useState(!1),[s,E]=d.useState(!1);d.useEffect(()=>{const o=t.getAllProjects(),a=t.getAccessToken();(o.length>0||a)&&(E(!0),r.warning("STALE DATA DETECTED ON SIGN IN PAGE"),r.warning("You have old data in storage that may cause errors."),r.warning('Click "Clear All Data" below before attempting to sign in.'))},[]);const j=async()=>{if(!m||!h){n("Please enter your email and password");return}n(""),c(!0),r.cleanup("Clearing all storage data before sign in..."),t.clearAll();try{const o=await fetch(`https://${w}.supabase.co/functions/v1/make-server-cf9a9609/auth/signin`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${T}`},body:JSON.stringify({email:m.toLowerCase().trim(),password:h})}),a=await o.json();if(!o.ok){o.status===401?(r.cleanup("Authentication failed - clearing stale storage data"),t.clearAll(),a.error?.includes("check your credentials or sign up")?n("Invalid email or password. If you don't have an account, please sign up first."):n(a.error||"Invalid email or password. Please check your credentials.")):n(a.error||"Sign in failed. Please try again."),c(!1);return}if(!a.success||!a.accessToken){n("Sign in failed. Please try again."),c(!1);return}const b=a.user.email,p=a.user.fullName||"";t.setAccessToken(a.accessToken),t.setUserEmail(b),p&&t.setUserFullName(p),r.sync("Fetching projects from backend...");try{const x=await fetch(`https://${w}.supabase.co/functions/v1/make-server-cf9a9609/projects`,{headers:{Authorization:`Bearer ${a.accessToken}`}});if(x.ok){const u=(await x.json()).projects||[];r.success(`Fetched ${u.length} projects from backend`),u.length>0?(t.clearAllAndRestoreAuth(a.accessToken,b,p),t.syncProjectsFromBackend(u),r.success("User has projects, redirecting to dashboard"),A.success("Welcome back!",{description:`You have ${u.length} project${u.length>1?"s":""}. Click Refresh to load the latest data.`,duration:5e3}),c(!1),i?.(f.DASHBOARD)):(t.clearAllAndRestoreAuth(a.accessToken,b,p),r.info("No projects found - user can view dashboard (admin will create projects)"),A.success("Welcome to Brand Sense!",{description:"Get started by creating your first project to monitor your brand.",duration:5e3}),c(!1),i?.(f.DASHBOARD))}else r.error("Failed to fetch projects from backend"),t.clearAllAndRestoreAuth(a.accessToken),r.info("Backend fetch failed, redirecting to dashboard"),c(!1),i?.(f.DASHBOARD)}catch(x){r.error("Error fetching projects:",x),t.clearAllAndRestoreAuth(a.accessToken),r.info("Network error, redirecting to dashboard"),c(!1),i?.(f.DASHBOARD)}}catch(o){r.error("Sign in error:",o),n("Network error. Please check your connection and try again."),c(!1)}},v=o=>{o.key==="Enter"&&!l&&j()};return e.jsxs("div",{className:"w-full max-w-[400px] mx-auto",children:[e.jsxs("button",{onClick:()=>i?.("landing"),disabled:l,className:"flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors mb-8 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(I,{className:"w-4 h-4"}),e.jsx("span",{className:"tracking-tight",children:"Back"})]}),e.jsxs("div",{className:"mb-10",children:[e.jsx("h1",{className:"mb-3 text-foreground tracking-tight",children:"Sign In"}),e.jsx("p",{className:"text-muted-foreground",children:"Access your Brand Sense dashboard"})]}),s&&e.jsx("div",{className:"mb-6 p-5 border-2 border-destructive rounded-lg bg-destructive/20 space-y-3",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(y,{className:"w-6 h-6 text-destructive mt-0.5 shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-destructive font-medium text-[15px] mb-2",children:"âš ï¸ OLD DATA DETECTED"}),e.jsx("p",{className:"text-destructive/90 text-[14px]",children:"Your browser has cached data from a previous session. This will cause sign in errors."})]}),e.jsxs("div",{className:"bg-destructive/10 border border-destructive/30 rounded-lg p-3 space-y-2",children:[e.jsx("p",{className:"text-destructive font-medium text-[13px]",children:"Required Action:"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-1 text-[13px] text-destructive/80",children:[e.jsx("li",{children:'Click "Clear All Data" button below'}),e.jsx("li",{children:"Page will reload automatically"}),e.jsx("li",{children:'Click "Sign Up" to create a NEW account'}),e.jsx("li",{children:"Do NOT use Sign In unless you created an account today"})]})]}),e.jsx("button",{onClick:()=>{confirm("This will clear all local data. Continue?")&&(r.cleanup("Clearing all storage data..."),t.clearAll(),window.location.reload())},className:"w-full px-4 py-3 rounded-lg bg-destructive text-white hover:bg-destructive/90 transition-all duration-150 font-medium text-[14px]",children:"ðŸ§¹ Clear All Data & Reload"})]})]})}),g&&!s&&e.jsx("div",{className:"mb-6 p-4 border border-destructive/50 rounded-lg bg-destructive/10 space-y-3",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(y,{className:"w-5 h-5 text-destructive mt-0.5 shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-destructive mb-2",children:g}),g.includes("Invalid email or password")&&e.jsxs("div",{className:"space-y-2 text-[13px]",children:[e.jsx("p",{className:"text-destructive/80 font-medium",children:"Most likely cause:"}),e.jsx("p",{className:"text-destructive/70 bg-destructive/5 p-2 rounded border border-destructive/20",children:`This account doesn't exist. Click "Sign Up" below to create a new account instead.`})]})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(N,{variant:"outline",disabled:s||!0,className:"w-full h-11 bg-card border-border opacity-50 cursor-not-allowed",children:[e.jsxs("svg",{className:"w-5 h-5 mr-3",viewBox:"0 0 24 24",children:[e.jsx("path",{fill:"#4285F4",d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),e.jsx("path",{fill:"#34A853",d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),e.jsx("path",{fill:"#FBBC05",d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),e.jsx("path",{fill:"#EA4335",d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),"Continue with Google (Coming Soon)"]}),e.jsxs("div",{className:"relative my-6",children:[e.jsx(B,{className:"bg-border"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("span",{className:"bg-background px-3 text-muted-foreground uppercase tracking-wider",children:"or"})})]}),e.jsxs("div",{className:`space-y-4 ${s?"opacity-50 pointer-events-none":""}`,children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"email",className:"text-foreground",children:"Email"}),e.jsx(C,{id:"email",type:"email",placeholder:s?"Clear data first":"you@company.com",value:m,onChange:o=>S(o.target.value),onKeyPress:v,disabled:l||s,className:"h-11 bg-card border-border focus:border-primary transition-colors"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(k,{htmlFor:"password",className:"text-foreground",children:"Password"}),e.jsx("button",{onClick:()=>i?.("forgot"),disabled:l||s,className:"text-muted-foreground hover:text-foreground transition-colors disabled:opacity-50",children:"Forgot?"})]}),e.jsx(C,{id:"password",type:"password",placeholder:s?"Clear data first":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",value:h,onChange:o=>D(o.target.value),onKeyPress:v,disabled:l||s,className:"h-11 bg-card border-border focus:border-primary transition-colors"})]}),e.jsx(N,{onClick:j,disabled:!m||!h||l||s,className:"w-full h-11 mt-6 bg-primary hover:bg-primary/90 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed",children:l?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"w-4 h-4 mr-2 animate-spin"}),"Signing In..."]}):s?"ðŸ”’ Clear Data to Sign In":"Sign In"})]}),e.jsxs("div",{className:"text-center mt-8 pt-6 border-t border-border",children:[e.jsx("span",{className:"text-muted-foreground",children:s?"After clearing data: ":"Don't have an account? "}),e.jsx("button",{onClick:()=>i?.("signup"),disabled:l,className:`transition-colors disabled:opacity-50 ${s?"text-primary font-medium hover:text-primary/90":"text-foreground hover:text-primary"}`,children:s?"â†’ Go to Sign Up":"Sign Up"})]}),!s&&e.jsx("div",{className:"text-center mt-4",children:e.jsx("button",{onClick:()=>{confirm("This will clear all local data including saved projects. Are you sure?")&&(t.clearAll(),window.location.reload())},className:"text-muted-foreground/60 hover:text-muted-foreground transition-colors text-[13px]",children:"Clear All Data"})})]})]})}export{U as SignIn};
